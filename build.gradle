// Live without gradle java plugin

if (!project.hasProperty('chapter') || !project.hasProperty('className')) {
    def message = '''ERROR: Missing project property
                    |Usage:
                    |gradle -Pchapter=<chapterX> -PclassName=<MyJavaClass> <command>'''.stripMargin()
    throw new InvalidUserDataException(message)
}

final String SOURCE_PATH = 'src/main/java'
final String BUILD_PATH  = 'build/src/main/java/'

task beforeCompile() {
    "mkdir -p $BUILD_PATH".execute().text
}

task compile() {
    def file = "$SOURCE_PATH/org/dsaenz/oca/$chapter/${className}.java"
    runCommand "javac -g -sourcepath $SOURCE_PATH -d $BUILD_PATH $file"
}

task run() {
    def klass = "org.dsaenz.oca.${chapter}.$className"
    runCommand "java -cp $BUILD_PATH $klass"
}

compile.dependsOn beforeCompile
run.dependsOn compile

def runCommand(command) {
    def sout = new StringBuilder(), serr = new StringBuilder()
    def proc = command.execute()
    proc.consumeProcessOutput(sout, serr)
    proc.waitFor()
    println sout
    println serr
}
